{% extends "base.html" %}
{% block scripts %}
    <script>

        window.onpopstate = function () {
            //history.go(0); //TODO: forward functionality
        };

        var filterform = $(".filterform").serialize();
        //var sortedby = filterform.
        $(document).ready(function(){
            loadTable();
            $(".filterform").change(updateTable);
        });

        function updateTable() {
            history.pushState({}, "asdf", '/pol/liste?' + filterform);
            loadTable();
        }

        function loadTable() {
            filterform = $(".filterform").serialize();
            $.ajax({
                type: "GET",
                url: '/pol/table',
                data: filterform,
                success: function(data) {
                    $('#table').html(data);
                    $('.tablesort span').removeClass();
                    var sortedby = parseInt($("#sorteringsform input:checked").attr('id').split('_')[2]);
                    {# TODO: error at site load if no query #}
                    var desc = sortedby % 2;
                    if (desc) {
                        $("#o_" + (sortedby - desc)).addClass("glyphicon glyphicon-triangle-bottom");
                    } else {
                        $("#o_" + (sortedby)).addClass("glyphicon glyphicon-triangle-top");
                    }
                }
            });
        }

        var sistvarenummer;
        function utvid(varenummer) {
            var sistvare = $('#' + sistvarenummer);
            if(sistvarenummer > 0) {
                sistvare.slideUp();
            }
            if (varenummer == sistvarenummer) {
                sistvarenummer = 0;
                return sistvarenummer;
            }
            sistvarenummer = varenummer;
            var vare = $('#' + varenummer);
            $.ajax({
                type: "GET",
                url: '/pol/produkt/'+varenummer,
                success: function(data) {
                    vare.html(data).slideDown();
                }
            });
        }

        function sort(query) {//TODO: have to press twice to toggle enhetspris at page load
            var valgt = $('#id_o_' + query);
            if (valgt.is(':checked'))
                $('#id_o_' + (query + 1)).prop("checked", true);
            else
                valgt.prop("checked", true);
            loadTable()
        }

    </script>
{% endblock scripts %}
{% block sidebar %}
    <form class="filterform">
        <div class="form-group">{{ varenavnform }}</div>
        <div id="varetypeform" class="form-group collapse">{{ varetypeform }}</div>
        {# TODO: faster/easier to minimize again #}
        <a class="btn btn-link" data-toggle="collapse" data-target="#varetypeform">Varetyper</a>
        <div class="form-group">{{ prisform }}</div>
        <div class="form-group">{{ volumform }}</div>
        <div class="form-group">{{ alkoholform }}</div>
        <div class="form-group">{{ enhetsprisform }}</div>
        <div class="form-group">{{ butikkategoriform }}</div>
        <div class="clear_both"></div>
        <div id="sorteringsform" class="form-group hidden">{{ sorteringsform }}</div>
    </form>
{% endblock sidebar %}
{% block content %}
    <div id="table"></div>
{% endblock content %}