{% extends "base.html" %}
{% block scripts %}
    <script>

        window.onpopstate = function () {
            // TODO: history.go(0);
        };

        var filterform = $(".filterform").serialize();
        //var sortedby = filterform.
        $(document).ready(function(){
            loadTable();
            $(".filterform").change(updateTable);
        });

        function updateTable() {
            // TODO: history.pushState({}, "asdf", '/pol?' + filterform);
            loadTable();
        }

        function loadTable() {
            filterform = $(".filterform").serialize();
            $.ajax({
                type: "GET",
                url: '/pol/table',
                data: filterform,
                success: function(data) {
                    $('#table').html(data);
                    $('.tablesort span').removeClass();
                    var sortedby = parseInt($("#sorteringsform input:checked").attr('id').split('_')[2]);
                    {# TODO: error at site load if no query #}
                    var desc = sortedby % 2;
                    if (desc) {
                        $("#o_" + (sortedby - desc)).addClass("glyphicon glyphicon-triangle-bottom");
                    } else {
                        $("#o_" + (sortedby)).addClass("glyphicon glyphicon-triangle-top");
                    }
                }
            });
        }

        var sistvarenummer;
        function utvid(varenummer) {
            var sistvare = $('#' + sistvarenummer);
            if(sistvarenummer > 0) {
                sistvare.slideUp();
            }
            if (varenummer == sistvarenummer) {
                sistvarenummer = 0;
                return sistvarenummer;
            }
            sistvarenummer = varenummer;
            var vare = $('#' + varenummer);
            $.ajax({
                type: "GET",
                url: '/pol/produkt/'+varenummer,
                success: function(data) {
                    vare.html(data).slideDown();
                }
            });
        }

        function sort(query) {//TODO: have to press twice to toggle enhetspris at page load
            var valgt = $('#id_o_' + query);
            if (valgt.is(':checked'))
                $('#id_o_' + (query + 1)).prop("checked", true);
            else
                valgt.prop("checked", true);
            loadTable()
        }

    </script>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css"/>
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
    <script>
        var kart;
        var karturl = 'https://simennj.cartodb.com/api/v2/viz/16b23eda-69d2-11e5-a1bb-0e674067d321/viz.json';
        function lastKart() {
            if ($('#kart').html().length == 0) {
                var options = {
                    infowindow: false,
                };
                cartodb.createVis('kart', 'https://simennj.cartodb.com/api/v2/viz/16b23eda-69d2-11e5-a1bb-0e674067d321/viz.json', options)
                        .done(function (vis, layers) {
                            //layers[1].setInteraction(true);
                            layers[1].setInteractivity("butikknavn, kategori");
                            layers[1].on('featureClick', function (e, latlng, pos, data) {
                                $('#id_butikkategori').val(data.kategori);
                                loadTable();
                            });
                        });
            }
        }
        function test() {
            console.log("asdf");
        }
    </script>
{% endblock scripts %}
{% block sidebar %}

    <form class="filterform">
        <div class="input-group">{{ varenavnform }}</div>
        <a class="btn btn-link" data-toggle="collapse" data-target="#varetypeform">Varetyper</a>

        <div id="varetypeform" class="collapse">
            {{ varetypeform }}
            <a class="btn btn-link" data-toggle="collapse" data-target="#varetypeform">Skjul</a>
        </div>
        {# TODO: faster/easier to minimize again #}
        {# TODO: add new labels #}
        <div class="input-group tofelts">{{ prisform }}</div>
        <div class="input-group tofelts">{{ volumform }}</div>
        <div class="input-group tofelts">{{ alkoholform }}</div>
        <div class="input-group tofelts">{{ enhetsprisform }}</div>
        <div class="input-group">
            {{ butikkategoriform }}
            <span class="input-group-btn">
                <button id="kartknapp" type="button" class="btn btn-default" data-toggle="collapse"
                        data-target="#kartholder" onclick="lastKart()">
                    <span aria-label="kart" class="glyphicon glyphicon-globe"></span>
                </button>
            </span>
        </div>
        <div class="clear_both"></div>
        <div id="sorteringsform" class="form-group hidden">{{ sorteringsform }}</div>
    </form>
{% endblock sidebar %}
{% block content %}
    <div id="kartholder" class="collapse">
        <div id="kart"></div>
    </div>
    <div id="table"></div>
{% endblock content %}